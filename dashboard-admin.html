<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>DENR-CENRO Diffun â€” Administrative Focal Dashboard</title>
    <link rel="icon" href="assets/denrlogo.png" type="image/svg+xml" />
    <style>
        :root {
            --green-900: #08331a;
            --green-700: #0b6137;
            --muted: #6b7280;
            --bg: #f7f9fb;
            --card: #ffffff;
            --radius: 12px;
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            background: linear-gradient(180deg, #f7fbf7 0%, #f7f9fb 100%);
            color: #0f172a
        }

        .app {
            display: flex;
            min-height: 100vh
        }

        .sidebar {
            width: 260px;
            background: var(--green-900);
            color: white;
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            transition: width .25s ease;
            box-shadow: 0 6px 18px rgba(3, 10, 7, 0.15)
        }

        .brand {
            display: flex;
            gap: 12px;
            align-items: center
        }

        .logo {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--green-700), var(--green-900));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700
        }

        .brand h1 {
            font-size: 15px;
            margin: 0
        }

        .brand p {
            margin: 0;
            font-size: 11px;
            opacity: .92
        }

        nav {
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: background .18s, transform .08s;
            user-select: none
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateX(4px)
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.03))
        }

        .nav-item svg {
            opacity: .95
        }

        .content {
            flex: 1;
            padding: 28px;
            display: flex;
            flex-direction: column;
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            width: 100%;
        }

        .title {
            font-size: 18px;
            font-weight: 700
        }

        .subtitle {
            color: var(--muted);
            font-size: 13px
        }

        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 18px;
            box-shadow: 0 6px 20px rgba(16, 24, 40, 0.06);
        }

        form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px
        }

        label {
            display: block;
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 6px
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e6eef3;
            background: transparent;
            font-size: 14px
        }

        textarea {
            min-height: 60px;
            resize: vertical
        }

        .full {
            grid-column: 1/-1
        }

        .actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 8px
        }

        button {
            padding: 10px 14px;
            border-radius: 10px;
            border: 0;
            background: var(--green-700);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: transform .12s, box-shadow .12s
        }

        button.secondary {
            background: transparent;
            color: var(--green-700);
            border: 1px solid rgba(11, 97, 55, 0.12)
        }

        button:active {
            transform: translateY(1px)
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px
        }

        thead th {
            text-align: left;
            padding: 12px 8px;
            color: var(--muted);
            font-size: 13px;
            border-bottom: 1px solid #eef5f7
        }

        tbody td {
            padding: 12px 8px;
            border-bottom: 1px solid #fbfcfd
        }

        .muted {
            color: var(--muted)
        }

        .row {
            display: flex;
            gap: 12px;
            align-items: center
        }

        .fade-in {
            animation: fadeIn .28s ease both
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(6px)
            }

            to {
                opacity: 1;
                transform: none
            }
        }

        @media (max-width:900px) {
            .sidebar {
                width: 68px;
                padding: 16px
            }

            .brand h1,
            .brand p {
                display: none
            }

            form {
                grid-template-columns: 1fr
            }

            .content {
                padding: 16px;
            }
        }

        /* Spinner */
        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #ccc;
            border-top-color: var(--green-700);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        /* Modal styles */
        .modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 1000;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--card);
            margin: auto;
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 90%;
            position: relative;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Updated status class styles */
        .status-pending {
            color: orange;
            font-weight: bold;
        }

        .status-sc-approved {
            color: var(--green-700);
            font-weight: bold;
        }

        .status-sc-disapproved {
            color: #ef4444;
            font-weight: bold;
        }

        .status-planning-pending {
            color: #8B5CF6;
            font-weight: bold;
        }

        /* New status color */
        .status-planning-approved {
            color: #10B981;
            font-weight: bold;
        }

        /* Tailwind green-500 */
        .status-planning-disapproved {
            color: #DC2626;
            font-weight: bold;
        }

        /* Tailwind red-600 */
        .status-cenro-approved {
            color: #2563eb;
            font-weight: bold;
        }

        /* Tailwind blue-600 */
        .status-cenro-disapproved {
            color: #DC2626;
            font-weight: bold;
        }
        
        /* New style for clickable cells */
        .copyable {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-decoration-color: var(--muted);
        }

        /* Tailwind red-600 */
    </style>
</head>
<body>
    <div class="app">
        <aside class="sidebar" id="sidebar">
            <div class="brand">
                <div class="logo">AD</div>
                <div>
                    <h1>Admin Focal</h1>
                    <p style="font-weight:600">Dashboard</p>
                </div>
            </div>

            <nav>
                <div class="nav-item active">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M3 7h18M3 12h18M3 17h18" stroke="white" stroke-width="1.6" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                    <div>Travel Orders for Printing</div>
                </div>
            </nav>

            <div style="margin-top:auto;font-size:12px;opacity:.95" id="statusContainer">
                <div class="muted">Status:</div>
                <div style="margin-top:6px;font-weight:700">Checking...</div>
            </div>
        </aside>

        <main class="content">
            <div id="topbar" class="topbar">
                <div>
                    <div class="title">Administrative Focal Dashboard</div>
                    <div class="subtitle">DENR-CENRO Diffun</div>
                </div>
            </div>

            <section id="view-list" class="card fade-in" style="font-size:12px; width: 100%;">
                <h3 style="margin-top:0; font-size:14px;">Travel Orders for Printing</h3>
                <div id="filterControls" style="display:flex; gap:12px; margin-bottom:12px;">
                    <div>
                        <label for="filterStatus" style="font-size:11px;">Filter by Status</label>
                        <select id="filterStatus" style="width:180px; font-size:12px; padding: 6px;"></select>
                    </div>
                    <div>
                        <label for="filterMonth" style="font-size:11px;">Filter by Month</label>
                        <input type="month" id="filterMonth" style="width:140px; font-size:12px; padding: 6px;">
                    </div>
                    <div style="margin-left: auto;">
                        <label style="font-size:11px;">Search All Fields</label>
                        <input type="text" id="searchInput" placeholder="Search..."
                            style="width:200px; font-size:12px; padding: 6px;">
                    </div>
                    <button id="printTableBtn" style="background-color: #2563eb; color: white; padding: 6px 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; align-self: flex-end;">Print Table</button>
                </div>
                <div id="listContainer">
                    <div class="muted" style="font-size:12px;">
                        Loading travel orders for printing...
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeEditModalBtn">&times;</span>
            <h3 style="margin-top:0">View Travel Order</h3>
            <form id="editForm">
                <input type="hidden" id="editRowIndex" name="rowIndex">
                <div>
                    <label for="editName">Name</label>
                    <select id="editName" name="name" required disabled></select>
                </div>
                <div>
                    <label for="editPosition">Position</label>
                    <select id="editPosition" name="position" required disabled></select>
                </div>
                <div>
                    <label for="editSection">Office / Section / Unit</label>
                    <select id="editSection" name="section" required disabled></select>
                </div>
                <div>
                    <label for="editSectionChief">Section Chief</label>
                    <select class="form-select" id="editSectionChief" name="sectionChief" required disabled></select>
                </div>
                <div>
                    <label for="editDepartureDate">Departure Date</label>
                    <input id="editDepartureDate" name="departureDate" type="date" required disabled />
                </div>
                <div>
                    <label for="editArrivalDate">Arrival Date</label>
                    <input id="editArrivalDate" name="arrivalDate" type="date" required disabled />
                </div>
                <div class="full">
                    <label for="editDestination">Destination</label>
                    <textarea id="editDestination" name="destination" required disabled></textarea>
                </div>
                <div class="full">
                    <label for="editPurpose">Purpose</label>
                    <textarea id="editPurpose" name="purpose" required disabled></textarea>
                </div>
                <div class="full">
                    <label for="editStatus">Status</label>
                    <select id="editStatus" name="status" required disabled>
                        <option value="CENRO-APPROVED">CENRO-APPROVED</option>
                        <option value="PRINTED">PRINTED</option>
                    </select>
                </div>

                <div class="actions full">
                    <button type="button" class="secondary" id="cancelEditBtn">Close</button>
                    <button type="button" id="showPrintPreviewBtn" style="background-color: #2563eb;">Print</button>
                </div>
            </form>
        </div>
    </div>

    <div id="printPreviewModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closePrintPreviewBtn">&times;</span>
            <h3 style="margin-top:0">Print Preview</h3>
            <div id="previewContent" style="padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 15px;">
                </div>
            <div class="actions full">
                <button type="button" class="secondary" id="cancelPrintBtn">Cancel</button>
                <button type="button" id="confirmPrintBtn" style="background-color: #2563eb;">Print</button>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzID3I4TqcCBfLay2jQdwoZshe41vAU42AELiesNtFjD3RisdTvC-FFgrApj-P0xRW-/exec';

        let currentPage = 1;
        let currentSearchTerm = '';
        let currentFilterMonth = '';
        let currentFilterStatus = 'All';

        const listContainer = document.getElementById('listContainer');
        const editModal = document.getElementById('editModal');
        const printPreviewModal = document.getElementById('printPreviewModal');
        const closeEditModalBtn = document.getElementById('closeEditModalBtn');
        const closePrintPreviewBtn = document.getElementById('closePrintPreviewBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const cancelPrintBtn = document.getElementById('cancelPrintBtn');
        const showPrintPreviewBtn = document.getElementById('showPrintPreviewBtn');
        const confirmPrintBtn = document.getElementById('confirmPrintBtn');
        const filterStatusSelect = document.getElementById('filterStatus');
        const filterMonthInput = document.getElementById('filterMonth');
        const searchInput = document.getElementById('searchInput');

        let allTravelOrders = [];
        let selectedTravelOrderData = null;

        const names = [
            "Abello, Denver John T.", "Acoba, Corazon S.", "Acosta, Mharycris G.", "Agcaoili, Jaymark R.", "Aloni, Mary H.", "Andres, Edrichein P.",
            "Ancheta, Eddie B.", "Ancheta, Vilma L.", "Arellano, Renato M.", "Bacarro, Julius Augustus B.", "Barayuga, Allan Jay D.",
            "Barrientos, Claudine M.", "Butic, Cyril D.", "Calantas, Aldrin James P.", "Concepcion, Ronnie B.",
            "Damance, Aldrin N.", "Damanse, Jennifer O.", "De Guzman, Mar B.", "De Vera, Jasmine Love N.", "Del Rosario, Gilbert D.",
            "Dellias, Jude C.", "Delos Santos, Roxann B.", "Gatin, Alvin B.", "Lazaro, June M.", "Lorete, Federico T.",
            "Mabborang, Corazon L.", "Magat, Sebastian M.", "Manglapuz, Ariel M.", "MariÃ±as-Gatin, Jennilyn G.", "Nahoy, Ngoy Ngoy D.",
            "Nanglihan, Romel B.", "Navarro, Alberto, Jr. P.", "Nonan, Maribel V.", "Ocampo, Florida Blanca S.", "Pagaduan, Raymark T.",
            "Pico, Susan D.", "Pulido, Ana Roberta", "Ribunal, Jaynaliza A.", "Romero, Marilou E.", "Romero, Randy C.",
            "Salvador, Dennis C.", "Santiago, Alejandro G.", "Seraspi, Jan Millius A.", "Simodio, Sonny O.", "Sojor, Marie Belle E.",
            "Soriano, Norissa Belle L.", "Viray, Rodelito B.", "Yanguas, Roque S."
        ];
  
        const positions = [
            "Administrative Aide I", "Administrative Aide VI", "Administrative Officer I", "Cartographer I", "Credit Officer", "C/Administrative Aide/Driver",
            "C/Data Management Officer", "C/Planning Support Staff", "C/Forester", "C/Forest Extension Officer", "C/Forest Protection Officer", "C/Nursery Aide",
            "C/Park Ranger", "C/Utility Worker", "C/Lams Encoder", "Ecosystems Management Specialist II", "Engineer II", "Forester I",
            "Forester II", "Forester III", "Forest Ranger", "Forest Technician I", "Forest Technician II",
            "IT Technical Support Staff", "Land Management Examiner",
            "Land Management Officer I", "Land Management Officer II", "Land Management Officer III", "Land Management Inspector", "Park Maintenance Foreman",
            "Park Ranger", "Senior Ecosystems Management Specialist", "Special Investigator I", "Special Investigator II", "Supervising Ecosystems Management Specialist"
        ];

        document.addEventListener('DOMContentLoaded', () => {
            ['All', 'CENRO-APPROVED'].forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                filterStatusSelect.appendChild(option);
            });

            filterStatusSelect.addEventListener('change', () => {
                currentFilterStatus = filterStatusSelect.value;
                renderTable(allTravelOrders, 1, currentSearchTerm, currentFilterMonth, currentFilterStatus);
            });

            filterMonthInput.addEventListener('change', () => {
                currentFilterMonth = filterMonthInput.value;
                renderTable(allTravelOrders, 1, currentSearchTerm, currentFilterMonth, currentFilterStatus);
            });

            searchInput.addEventListener('input', () => {
                currentSearchTerm = searchInput.value;
                renderTable(allTravelOrders, 1, currentSearchTerm, currentFilterMonth, currentFilterStatus);
            });

            document.getElementById('printTableBtn').addEventListener('click', printTable);

            loadList();
        });

        closeEditModalBtn.addEventListener('click', () => {
            editModal.style.display = 'none';
        });

        cancelEditBtn.addEventListener('click', () => {
            editModal.style.display = 'none';
        });

        closePrintPreviewBtn.addEventListener('click', () => {
            printPreviewModal.style.display = 'none';
        });

        cancelPrintBtn.addEventListener('click', () => {
            printPreviewModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target === editModal) {
                editModal.style.display = 'none';
            }
            if (event.target === printPreviewModal) {
                printPreviewModal.style.display = 'none';
            }
        });

        showPrintPreviewBtn.addEventListener('click', () => {
            const rowData = selectedTravelOrderData;
            if (!rowData) {
                showMessageModal('No travel order data found.');
                return;
            }

            const data = {
                name: getVal(rowData, ['Name', 'name']),
                position: getVal(rowData, ['Position', 'position']),
                divisionUnit: getVal(rowData, ['Section', 'section']),
                departureDate: formatDateTime(getVal(rowData, ['Departure Date', 'departureDate'])),
                arrivalDate: formatDateTime(getVal(rowData, ['Arrival Date', 'arrivalDate'])),
                destination: getVal(rowData, ['Destination', 'destination']),
                purpose: getVal(rowData, ['Purpose', 'purpose']),
                sectionChief: getVal(rowData, ['SectionChief', 'sectionChief']),
                officialStation: 'CENRO',
                fundAppropriation: 'Per COA Regulation',
                remarks: 'NONE',
                approved: 'CORAZON L. MABORRANG, RPF'
            };

            let recommendingApprovalHTML = '';
            let recommendingApprovalNameHTML = '';
            let recommendingApprovalPositionHTML = '';

            if (data.sectionChief !== 'NONE') {
                let recommendingApprovalSignatureHTML = '';
                if (data.sectionChief === 'JENNIFER O. DAMANSE, RPF') {
                    recommendingApprovalSignatureHTML = '<img src="assets/CDS-ESIG.png" alt="e-signature" style="height: 50px; display: block; margin: 3mm auto 0;">';
                } else if (data.sectionChief === 'JUNE M. LAZARO, RPF') {
                    recommendingApprovalSignatureHTML = '<img src="assets/EMS-ESIG.png" alt="e-signature" style="height: 50px; display: block; margin: 3mm auto 0;">';
                } else if (data.sectionChief === 'ENGR. SEBASTIAN M. MAGAT') {
                    recommendingApprovalSignatureHTML = '<img src="assets/RPS-ESIG.png" alt="e-signature" style="height: 50px; display: block; margin: 3mm auto 0;">';
                }
                recommendingApprovalHTML = '<td style="text-align: center;"><strong>Recommending Approval</strong></td>';
                recommendingApprovalNameHTML = `<td style="padding-top: 5px; text-align: center;">${recommendingApprovalSignatureHTML}<u>${data.sectionChief}</u></td>`;
                recommendingApprovalPositionHTML = `<td style="text-align: center;">Section Chief</td>`;
            }

            const previewHTML = `
    <div style="font-family: Arial, sans-serif; font-size: 10px; color: #000; padding: 30px;">
        <table style="width: 100%; margin-bottom: 8px;">
            <tr>
                <td style="width: 80px;">
                    <img src="assets/denrlogo.png" alt="DENR Logo" style="height: 70px;" />
                </td>
                <td style="text-align: left; font-size: 11px; line-height: 1.2;">
                    <div><strong>Republic of the Philippines</strong></div>
                    <div><strong>Department of Environment and Natural Resources</strong></div>
                    <div><strong>Community Environment and Natural Resources Office</strong></div>
                    <div>Province of Quirino</div>
                    <div>Andres Bonifacio, Diffun, Quirino, 3401</div>
                    <div>Email Address: denr.diffun@gmail.com</div>
                </td>
            </tr>
        </table>
        <h4 style="text-align: center; text-decoration: underline; font-weight: bold; font-size: 12px; margin: 16px 0;">TRAVEL ORDER</h4>
        <div style="text-align: center; margin-bottom: 8px;">(No. ______________________)</div>
        <table style="width: 100%; margin-bottom: 8px; font-size: 10px;">
            <tr>
                <td><strong>Name:</strong> ${data.name}</td>
                <td><strong>Salary:</strong></td>
            </tr>
            <tr>
                <td><strong>Position:</strong> ${data.position}</td>
                <td><strong>Div/Sec/Unit:</strong> ${data.divisionUnit}</td>
            </tr>
            <tr>
                <td><strong>Departure Date:</strong> ${data.departureDate}</td>
                <td><strong>Official Station:</strong> ${data.officialStation}</td>
            </tr>
            <tr>
                <td><strong>Destination:</strong> ${data.destination}</td>
                <td><strong>Arrival Date:</strong> ${data.arrivalDate}</td>
            </tr>
        </table>
        <p style="margin: 8px 0;"><strong>Purpose:</strong><br>${data.purpose}</p>
        <p style="margin: 8px 0;"><strong>Per Diems/Expenses Allowed:</strong> ${data.fundAppropriation}</p>
        <p style="margin: 8px 0;"><strong>Remarks or special instructions:</strong><br>${data.remarks}</p>
        <p style="margin: 8px 0;"><strong>CERTIFICATION:</strong><br>
            This is to certify that the travel is necessary and is connected with the functions of the official/employee of this Division/Section/Unit.
        </p>
        <table style="width: 100%; margin-top: 0px; text-align: center; font-size: 10px;">
            <tr>
                ${recommendingApprovalHTML}
                <td><strong>APPROVED BY</strong></td>
            </tr>
            <tr>
                ${recommendingApprovalNameHTML}
                <td style="padding-top: 5px; text-align: center;">
                    <img src="assets/CENRO-ESIG.png" alt="CENRO e-signature" style="height: 50px; display: block; margin: 3mm auto 0;" />
                    <u>${data.approved}</u>
                </td>
            </tr>
            <tr>
                ${recommendingApprovalPositionHTML}
                <td>OIC, CENR Officer</td>
            </tr>
        </table>
        <hr style="margin: 5px 0;">
        <div style="text-align: center; font-weight: bold; font-size: 12px; margin-top: 16px;">AUTHORIZATION</div>
        <p style="text-align: justify; font-size: 10px; margin-top: 8px;">
            I hereby authorize the accountant to deduct the corresponding amount of the unliquidated cash advance
            from succeding salary for my failure to liquidate this travel within the prescribed thirty-day period upon return to my permanent official station pursuant to Item 5.1.3 COA Circular 97-002 dated February 10, 1997 and Sec. 16 EO No. 248 dated May 29, 1995.
        </p>
        <table style="width: 100%; margin-top: 0px; text-align: right; font-size: 10px;">
            <tr>
                <td><u>${data.name}</u></td>
            </tr>
            <tr>
                <td><strong>Official/Employee</strong></td>
            </tr>
        </table>
        <div style="text-align: center; font-weight: bold; font-size: 12px; margin-top: 16px;">CERTIFICATE OF APPEARANCE</div>
        <p style="text-align: justify; font-size: 10px; margin-top: 8px;">
            THIS IS TO CERTIFY that <u>${data.name}</u> personally appeared on the date and place indicated below:
        </p>
        <p style="text-align: justify; font-size: 10px; margin-top: 8px;">
            This certification is issued upon request of Mr./Ms. <u>${data.name}</u> in compliance with standard auditing regulations provided for under <strong>Republic Act No. 3347</strong>, duly implemented by <strong>COA Circular No. 68-A</strong>, for the purpose of establishing the evidence and duration of his/her appearance thereat, the truth of which is hereby vouchsafe and guaranteed by the undersigned.
        </p>
        <table style="width: 100%; border: 1px solid #000; border-collapse: collapse; margin-top: 8px; font-size: 10px;">
            <thead>
                <tr>
                    <th style="border: 1px solid #000; padding: 4px;">Control Number</th>
                    <th style="border: 1px solid #000; padding: 4px;">Date of Execution</th>
                    <th style="border: 1px solid #000; padding: 4px;">Place of Execution</th>
                    <th style="border: 1px solid #000; padding: 4px;">Purpose</th>
                    <th style="border: 1px solid #000; padding: 4px;">Certifying Officer</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="border: 1px solid #000; padding: 4px;"></td>
                    <td style="border: 1px solid #000; padding: 4px;"></td>
                    <td style="border: 1px solid #000; padding: 4px;"></td>
                    <td style="border: 1px solid #000; padding: 4px;"></td>
                    <td style="border: 1px solid #000; padding: 4px;"></td>
                </tr>
                <tr>
                    <td style="border: 1px solid #000; padding: 4px;"></td>
                    <td style="border: 1px solid #000; padding: 4px;"></td>
                    <td style="border: 1px solid #000; padding: 4px;"></td>
                    <td style="border: 1px solid #000; padding: 4px;"></td>
                    <td style="border: 1px solid #000; padding: 4px;"></td>
                </tr>
                <tr>
                    <td style="border: 1px solid #000; padding: 4px;"></td>
                    <td style="border: 1px solid #000; padding: 4px;"></td>
                    <td style="border: 1px solid #000; padding: 4px;"></td>
                    <td style="border: 1px solid #000; padding: 4px;"></td>
                    <td style="border: 1px solid #000; padding: 4px;"></td>
                </tr>
            </tbody>
        </table>

        <div style="text-align: right; margin-top: 30px;">
            <img src="assets/MARK.png" alt="DENR Seal" style="height: 60px;" />
        </div>
    </div>
`;


            const previewContent = document.getElementById('previewContent');
            previewContent.innerHTML = previewHTML;
            editModal.style.display = 'none';
            printPreviewModal.style.display = 'flex';
        });

        confirmPrintBtn.addEventListener('click', () => {
            const rowData = selectedTravelOrderData;
            if (!rowData) {
                showMessageModal('No travel order data found for printing.');
                return;
            }

            const printContent = document.getElementById('previewContent').innerHTML;

            const printWindow = window.open('', '_blank');
            printWindow.document.open();
            printWindow.document.write('<!DOCTYPE html><html><head><title>Print Travel Order</title>');
            printWindow.document.write('<style>');
            printWindow.document.write('body { font-family: Arial, sans-serif; font-size: 10px; color: #000; padding: 0; margin: 0; }');
            printWindow.document.write('table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }');
            printWindow.document.write('img { height: 70px; }');
            printWindow.document.write('h4 { text-align: center; text-decoration: underline; font-weight: bold; font-size: 12px; margin: 16px 0; }');
            printWindow.document.write('.container { padding: 30px; }');
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<div class="container">' + printContent + '</div>');
            printWindow.document.close();

            printWindow.onload = () => {
                printWindow.print();
                printWindow.close();
                printPreviewModal.style.display = 'none';
                const name = getVal(rowData, ['Name', 'name']);
                showMessageModal(`âœ… Travel Order for ${name} is being printed.`);
            };
        });

        async function loadList() {
            listContainer.innerHTML = `
                <div style="display:flex;align-items:center;gap:8px;color:var(--muted)">
                    <div class="spinner"></div>
                    Loading travel orders for printing...
                </div>`;
            await checkConnection();
            try {
                const res = await fetch(`${GAS_URL}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const rows = await res.json();
                if (!Array.isArray(rows)) throw new Error("Invalid JSON format");

                allTravelOrders = rows.filter(order => order.status === 'CENRO-APPROVED' || order.status === 'PRINTED');

                currentPage = 1;
                currentSearchTerm = searchInput.value;
                currentFilterMonth = filterMonthInput.value;
                currentFilterStatus = filterStatusSelect.value;
                renderTable(allTravelOrders, currentPage, currentSearchTerm, currentFilterMonth, currentFilterStatus);
                console.log("Dashboard updated successfully.");

            } catch (err) {
                console.error("Error loading list:", err);
                listContainer.innerHTML = '<div class="muted">Failed to fetch list. Make sure your Google Apps Script is updated and deployed correctly.</div>';
            }
        }

        function esc(text) {
            return String(text || '').replace(/[&<>"']/g, m => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[m]));
        }

        function getVal(row, keys) {
            for (let k of keys) {
                let v = row[k];
                if (v !== undefined && v !== null && String(v).trim() !== '') return String(v).trim();
            }
            return '';
        }

        function formatDateForInput(dateString) {
            const d = new Date(dateString);
            if (isNaN(d.getTime())) return '';
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateTime(d) {
            if (!d) return '';
            const date = new Date(d);
            return isNaN(date.getTime()) ? d : date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function formatDateTimeReadable(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '-';
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        function renderTable(rows, page = 1, searchTerm = '', filterMonth = '', filterStatus = 'All') {
            currentPage = page;
            currentSearchTerm = searchTerm;
            currentFilterMonth = filterMonth;
            currentFilterStatus = filterStatus;

            const rowsPerPage = 10;

            const filteredRows = rows.filter(r => {
                const name = getVal(r, ['Name', 'name']);
                const position = getVal(r, ['Position', 'position']);
                const section = getVal(r, ['Section', 'section']);
                const purpose = getVal(r, ['Purpose', 'purpose']);
                const destination = getVal(r, ['Destination', 'destination']);
                const departureDate = getVal(r, ['Departure Date', 'departureDate']);
                const status = getVal(r, ['Status', 'status']);

                const searchMatch = (name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    position.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    section.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    purpose.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    destination.toLowerCase().includes(searchTerm.toLowerCase()));

                const monthMatch = !filterMonth || (departureDate && formatDateForInput(departureDate).startsWith(filterMonth));

                const statusMatch = filterStatus === 'All' || status === filterStatus;

                return searchMatch && monthMatch && statusMatch;
            });

            if (filteredRows.length === 0) {
                listContainer.innerHTML = '<div class="muted">No travel orders match your search and filter criteria.</div>';
                return;
            }

            const start = (page - 1) * rowsPerPage;
            const paginatedRows = filteredRows.slice(start, start + rowsPerPage);

            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.marginTop = '12px';

            const thead = document.createElement('thead');
            const trh = document.createElement('tr');
            ['Name', 'Position', 'Section', 'Departure Date', 'Arrival Date', 'Purpose', 'Destination', 'Status', 'Actions']
                .forEach(h => {
                    const th = document.createElement('th');
                    th.textContent = h;
                    th.style.textAlign = 'left';
                    th.style.padding = '12px 8px';
                    th.style.color = 'var(--muted)';
                    th.style.fontSize = '13px';
                    th.style.borderBottom = '1px solid #eef5f7';
                    trh.appendChild(th);
                });
            thead.appendChild(trh);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            paginatedRows.forEach(r => {
                const tr = document.createElement('tr');
                const name = getVal(r, ['Name', 'name']);
                const position = getVal(r, ['Position', 'position']);
                const section = getVal(r, ['Section', 'section']);
                const departure = getVal(r, ['Departure Date', 'departureDate']);
                const arrival = getVal(r, ['Arrival Date', 'arrivalDate']);
                const purpose = getVal(r, ['Purpose', 'purpose']);
                const destination = getVal(r, ['Destination', 'destination']);
                const status = getVal(r, ['Status', 'status']) || 'Pending';
                const rowIndex = r.rowIndex;

                [
                    name,
                    position,
                    section,
                    formatDateTime(departure),
                    formatDateTime(arrival),
                    purpose,
                    destination,
                    status,
                ].forEach((cellText, index) => {
                    const td = document.createElement('td');
                    td.style.padding = '12px 8px';
                    td.style.borderBottom = '1px solid #fbfcfd';

                    if (index === 5 || index === 6) { // For 'Purpose' and 'Destination' columns
                        const fullText = cellText;
                        td.setAttribute('data-full-text', fullText);
                        td.classList.add('copyable');
                        td.addEventListener('click', () => copyToClipboard(td));

                        let displayText = (fullText && fullText.length > 20) ? fullText.substring(0, 20) + 'â€¦' : (fullText || '-');
                        td.textContent = displayText;
                        td.title = fullText || '';
                    } else if (index === 7) {
                        td.textContent = cellText;
                        if (cellText.toLowerCase() === 'sc-approved') {
                            td.classList.add('status-sc-approved');
                        } else if (cellText.toLowerCase() === 'sc-disapproved') {
                            td.classList.add('status-sc-disapproved');
                        } else if (cellText.toLowerCase() === 'planning-pending') {
                            td.classList.add('status-planning-pending');
                        } else if (cellText.toLowerCase() === 'planning-approved') {
                            td.classList.add('status-planning-approved');
                        } else if (cellText.toLowerCase() === 'planning-disapproved') {
                            td.classList.add('status-planning-disapproved');
                        } else if (cellText.toLowerCase() === 'cenro-approved') {
                            td.classList.add('status-cenro-approved');
                        } else if (cellText.toLowerCase() === 'cenro-disapproved') {
                            td.classList.add('status-cenro-disapproved');
                        } else {
                            td.classList.add('status-pending');
                        }
                    } else {
                        td.textContent = esc(cellText) || '-';
                    }
                    tr.appendChild(td);
                });

                const actionsTd = document.createElement('td');
                actionsTd.style.whiteSpace = 'nowrap';

                const viewUpdateBtn = document.createElement('button');
                viewUpdateBtn.textContent = 'View/Print';
                viewUpdateBtn.style.backgroundColor = 'transparent';
                viewUpdateBtn.style.color = 'var(--green-700)';
                viewUpdateBtn.style.border = '1px solid rgba(11,97,55,0.12)';
                viewUpdateBtn.style.padding = '5px 8px';
                viewUpdateBtn.style.borderRadius = '5px';
                viewUpdateBtn.addEventListener('click', () => openEditModal(r, rowIndex));

                actionsTd.appendChild(viewUpdateBtn);
                tr.appendChild(actionsTd);

                tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            listContainer.innerHTML = '';
            listContainer.appendChild(table);

            const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
            const paginationDiv = document.createElement('div');
            paginationDiv.style.marginTop = '12px';
            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.style.padding = '5px 10px';
                btn.style.borderRadius = '5px';
                btn.style.marginRight = '5px';
                btn.classList.add('pagination-button');

                if (i === page) {
                    btn.classList.add('active');
                    btn.style.border = 'none';
                    btn.style.backgroundColor = 'var(--green-700)';
                    btn.style.color = 'white';
                } else {
                    btn.classList.remove('active');
                    btn.style.border = '1px solid rgba(11,97,55,0.12)';
                    btn.style.backgroundColor = 'transparent';
                    btn.style.color = 'var(--green-700)';
                }

                btn.addEventListener('click', () => {
                    renderTable(allTravelOrders, i, currentSearchTerm, currentFilterMonth, currentFilterStatus);
                });
                paginationDiv.appendChild(btn);
            }
            listContainer.appendChild(paginationDiv);
        }

        function openEditModal(rowData, rowIndex) {
            selectedTravelOrderData = rowData;
            document.getElementById('editRowIndex').value = rowIndex;
            const currentStatus = getVal(rowData, ['Status', 'status']);
            const printBtn = document.getElementById('showPrintPreviewBtn');

            if (currentStatus === 'CENRO-APPROVED') {
                printBtn.style.display = 'block';
            } else {
                printBtn.style.display = 'none';
            }

            const setSelectValueAndDisable = (selectId, value, optionsArray = []) => {
                const selectElement = document.getElementById(selectId);
                selectElement.innerHTML = '';
                let found = false;

                optionsArray.forEach(optVal => {
                    const option = document.createElement('option');
                    option.value = optVal;
                    option.textContent = optVal;
                    selectElement.appendChild(option);
                    if (optVal.trim() === value.trim()) {
                        found = true;
                    }
                });

                if (!found && value) {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    selectElement.appendChild(option);
                } else if (!value) {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "N/A";
                    selectElement.appendChild(option);
                }
                selectElement.value = value;
                selectElement.disabled = true;
            };

            setSelectValueAndDisable('editName', getVal(rowData, ['Name', 'name']), names);
            setSelectValueAndDisable('editPosition', getVal(rowData, ['Position', 'position']), positions);
            setSelectValueAndDisable('editSection', getVal(rowData, ['Section', 'section']), ["Conservation & Development Section", "Monitoring & Enforcement Section", "Regulation & Permitting Section", "Planning & Support Unit", "Office of the CENR Officer"]);
            setSelectValueAndDisable('editSectionChief', getVal(rowData, ['SectionChief', 'sectionChief']), ["JENNIFER O. DAMANSE, RPF", "JUNE M. LAZARO, RPF", "ENGR. SEBASTIAN M. MAGAT", "NONE"]);


            document.getElementById('editDepartureDate').value = formatDateForInput(getVal(rowData, ['Departure Date', 'departureDate']));
            document.getElementById('editArrivalDate').value = formatDateForInput(getVal(rowData, ['Arrival Date', 'arrivalDate']));
            document.getElementById('editDestination').value = getVal(rowData, ['Destination', 'destination']);
            document.getElementById('editPurpose').value = getVal(rowData, ['Purpose', 'purpose']);

            document.getElementById('editDepartureDate').disabled = true;
            document.getElementById('editArrivalDate').disabled = true;
            document.getElementById('editDestination').disabled = true;
            document.getElementById('editPurpose').disabled = true;

            const editStatusSelect = document.getElementById('editStatus');
            editStatusSelect.value = getVal(rowData, ['Status', 'status']);
            editStatusSelect.disabled = true;

            editModal.style.display = 'flex';
        }

        function showMessageModal(message) {
            const messageModal = document.createElement('div');
            messageModal.className = 'modal';
            messageModal.style.display = 'flex';
            messageModal.innerHTML = `
                <div class="modal-content" style="max-width: 400px; text-align: center;">
                    <span class="close-button">&times;</span>
                    <p>${esc(message)}</p>
                    <button style="margin-top: 15px; background-color: var(--green-700); color: white;" onclick="this.closest('.modal').style.display='none';">OK</button>
                </div>
            `;
            document.body.appendChild(messageModal);
            messageModal.querySelector('.close-button').onclick = () => messageModal.style.display = 'none';
            messageModal.onclick = (event) => {
                if (event.target === messageModal) messageModal.style.display = 'none';
            };
        }

        async function checkConnection() {
            const statusEl = document.getElementById('statusContainer');
            try {
                const res = await fetch(GAS_URL);
                if (res.ok) {
                    statusEl.innerHTML = `<div class="muted">Status:</div>
                        <div style="margin-top:6px;font-weight:700;color:#22c55e">Connected</div>`;
                } else {
                    throw new Error();
                }
            } catch {
                statusEl.innerHTML = `<div class="muted">Status:</div>
                    <div style="margin-top:6px;font-weight:700;color:#ef4444">Not Connected</div>`;
            }
        }

        function printTable() {
    const tableContainer = document.getElementById('listContainer');
    const dataTable = tableContainer.querySelector('table');

    if (!dataTable) {
        showMessageModal('No travel orders to print.');
        return;
    }

    let monthYearText = '';
    if (currentFilterMonth) {
        const [year, month] = currentFilterMonth.split('-');
        const date = new Date(year, month - 1);
        monthYearText = ` in the month of ${date.toLocaleString('en-US', { month: 'long', year: 'numeric' })}`;
    }

    const headerHtml = `
        <div style="font-family: Arial, sans-serif; font-size: 8px; color: #000;">
            <table style="width: 100%; margin-bottom: 8px;">
                <tr>
                    <td style="width: 80px;">
                        <img src="assets/denrlogo.png" alt="DENR Logo" style="height: 70px;" />
                    </td>
                    <td style="text-align: left; font-size: 10px; line-height: 1.2;">
                        <div><strong>Republic of the Philippines</strong></div>
                        <div><strong>Department of Environment and Natural Resources</strong></div>
                        <div><strong>Community Environment and Natural Resources Office</strong></div>
                        <div>Province of Quirino</div>
                        <div>Andres Bonifacio, Diffun, Quirino, 3401</div>
                        <div>Email Address: denr.diffun@gmail.com</div>
                    </td>
                </tr>
                
            </table>
            <div style="text-align: center;">
            <h3 style="margin-top:0; font-size:12px;">Approved Travel Orders ${monthYearText}</h3>
        </div>
    `;

    const footerHtml = `
        <div style="text-align: right;">
            <img src="assets/MARK.png" alt="DENR Seal" style="height: 40px; margin-bottom: 5px;" />
        </div>
    `;

    const printTable = document.createElement('table');
    const printThead = document.createElement('thead');
    const printTbody = document.createElement('tbody');
    printTable.style.fontSize = '10px';

    const headers = Array.from(dataTable.querySelectorAll('th'));
    const headerRow = document.createElement('tr');
    headers.forEach(header => {
        // Skip the "Actions" column
        if (header.textContent.trim() !== 'Actions') {
            headerRow.appendChild(header.cloneNode(true));
        }
    });
    printThead.appendChild(headerRow);
    printTable.appendChild(printThead);

    const rows = Array.from(dataTable.querySelectorAll('tbody tr'));
    rows.forEach(row => {
        const newRow = document.createElement('tr');
        const cells = Array.from(row.querySelectorAll('td'));
        cells.forEach((cell, index) => {
            // Skip the last cell which is the "Actions" column
            if (index < cells.length - 1) {
                newRow.appendChild(cell.cloneNode(true));
            }
        });
        printTbody.appendChild(newRow);
    });
    printTable.appendChild(printTbody);

    const tableHtml = printTable.outerHTML;

    const printWindow = window.open('', '_blank');
    printWindow.document.write('<!DOCTYPE html>');
    printWindow.document.write('<html><head><title>Print Travel Orders</title>');
    printWindow.document.write('<style>');
    printWindow.document.write('body { margin: 0; font-family: sans-serif; }');
    printWindow.document.write('table { width: 100%; border-collapse: collapse; }');
    printWindow.document.write('th, td { border: 1px solid #ddd; padding: 4px; text-align: left; }');
    printWindow.document.write('</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(headerHtml);
    printWindow.document.write(tableHtml);
    printWindow.document.write(footerHtml);
    printWindow.document.write('</div></body></html>');
    printWindow.document.close();

    printWindow.onload = () => {
        printWindow.print();
        printWindow.close();
    };
}

        // New function to copy text to clipboard
        function copyToClipboard(element) {
            const textToCopy = element.getAttribute('data-full-text');
            if (textToCopy) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    const originalContent = element.innerHTML;
                    element.innerHTML = 'Copied!';
                    setTimeout(() => {
                        element.innerHTML = originalContent;
                    }, 1000);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                });
            }
        }

        window.addEventListener('load', () => {
            document.querySelectorAll('.card').forEach((c, i) => {
                c.style.animationDelay = (i * 40) + 'ms';
            });
        });

        setInterval(loadList, 180000);
    </script>
</body>
</html>